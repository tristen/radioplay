/*!
 * Modest Maps JS v0.20.0
 * http://modestmaps.com/
 *
 * Copyright (c) 2011 Stamen Design, All Rights Reserved.
 *
 * Open source under the BSD License.
 * http://creativecommons.org/licenses/BSD/
 *
 * Versioned using Semantic Versioning (v.major.minor.patch)
 * See CHANGELOG and http://semver.org/ for more details.
 * 
 */// namespacing!
if(!com){var com={};com.modestmaps||(com.modestmaps={})}(function(a){a.extend=function(a,b){for(var c in b.prototype)typeof a.prototype[c]=="undefined"&&(a.prototype[c]=b.prototype[c]);return a},a.getFrame=function(){return function(a){(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+(new Date))},10)})(a)}}(),a.transformProperty=function(a){if(!!this.document){var b=document.documentElement.style;for(var c=0;c<a.length;c++)if(a[c]in b)return a[c];return!1}}(["transformProperty","WebkitTransform","OTransform","MozTransform","msTransform"]),a.matrixString=function(b){b.scale*b.width%1&&(b.scale+=(1-b.scale*b.width%1)/b.width);if(a._browser.webkit3d)return"matrix3d("+[b.scale||"1","0,0,0,0",b.scale||"1","0,0","0,0,1,0",(b.x+(b.width*b.scale-b.width)/2).toFixed(4),(b.y+(b.height*b.scale-b.height)/2).toFixed(4),0,1].join(",")+")";var c=a.transformProperty=="MozTransform"?"px":"";return"matrix("+[b.scale||"1",0,0,b.scale||"1",b.x+(b.width*b.scale-b.width)/2+c,b.y+(b.height*b.scale-b.height)/2+c].join(",")+")"},a._browser=function(a){return{webkit:"WebKitCSSMatrix"in a,webkit3d:"WebKitCSSMatrix"in a&&"m11"in new WebKitCSSMatrix}}(this),a.moveElement=function(b,c){if(a.transformProperty){var d=a.matrixString(c);b[a.transformProperty]!==d&&(b.style[a.transformProperty]=b[a.transformProperty]=d)}else b.style.left=c.x+"px",b.style.top=c.y+"px",b.style.width=Math.ceil(c.width*c.scale)+"px",b.style.height=Math.ceil(c.height*c.scale)+"px"},a.cancelEvent=function(a){a.cancelBubble=!0,a.cancel=!0,a.returnValue=!1,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault();return!1},a.addEvent=function(a,b,c){a.attachEvent?(a["e"+b+c]=c,a[b+c]=function(){a["e"+b+c](window.event)},a.attachEvent("on"+b,a[b+c])):(a.addEventListener(b,c,!1),b=="mousewheel"&&a.addEventListener("DOMMouseScroll",c,!1))},a.bind=function(a,b){var c=Array.prototype.slice,d=Function.prototype.bind;if(a.bind===d&&d)return d.apply(a,c.call(arguments,1));var e=c.call(arguments,2);return function(){return a.apply(b,e.concat(c.call(arguments)))}},a.removeEvent=function(a,b,c){a.detachEvent?(a.detachEvent("on"+b,a[b+c]),a[b+c]=null):(a.removeEventListener(b,c,!1),b=="mousewheel"&&a.removeEventListener("DOMMouseScroll",c,!1))},a.getStyle=function(a,b){if(a.currentStyle)return a.currentStyle[b];if(window.getComputedStyle)return document.defaultView.getComputedStyle(a,null).getPropertyValue(b)},a.Point=function(a,b){this.x=parseFloat(a),this.y=parseFloat(b)},a.Point.prototype={x:0,y:0,toString:function(){return"("+this.x.toFixed(3)+", "+this.y.toFixed(3)+")"}},a.Point.distance=function(a,b){var c=b.x-a.x,d=b.y-a.y;return Math.sqrt(c*c+d*d)},a.Point.interpolate=function(b,c,d){var e=b.x+(c.x-b.x)*d,f=b.y+(c.y-b.y)*d;return new a.Point(e,f)},a.Coordinate=function(a,b,c){this.row=a,this.column=b,this.zoom=c},a.Coordinate.prototype={row:0,column:0,zoom:0,toString:function(){return"("+this.row.toFixed(3)+", "+this.column.toFixed(3)+" @"+this.zoom.toFixed(3)+")"},toKey:function(){return[this.zoom,this.row,this.column].join(",")},copy:function(){return new a.Coordinate(this.row,this.column,this.zoom)},container:function(){return new a.Coordinate(Math.floor(this.row),Math.floor(this.column),Math.floor(this.zoom))},zoomTo:function(b){var c=Math.pow(2,b-this.zoom);return new a.Coordinate(this.row*c,this.column*c,b)},zoomBy:function(b){var c=Math.pow(2,b);return new a.Coordinate(this.row*c,this.column*c,this.zoom+b)},up:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row-b,this.column,this.zoom)},right:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row,this.column+b,this.zoom)},down:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row+b,this.column,this.zoom)},left:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row,this.column-b,this.zoom)}},a.Location=function(a,b){this.lat=parseFloat(a),this.lon=parseFloat(b)},a.Location.prototype={lat:0,lon:0,toString:function(){return"("+this.lat.toFixed(3)+", "+this.lon.toFixed(3)+")"}},a.Location.distance=function(a,b,c){c||(c=6378e3);var d=Math.PI/180,e=a.lat*d,f=a.lon*d,g=b.lat*d,h=b.lon*d,i=Math.cos(e)*Math.cos(f)*Math.cos(g)*Math.cos(h),j=Math.cos(e)*Math.sin(f)*Math.cos(g)*Math.sin(h),k=Math.sin(e)*Math.sin(g);return Math.acos(i+j+k)*c},a.Location.interpolate=function(b,c,d){if(b.lat===c.lat&&b.lon===c.lon)return new a.Location(b.lat,b.lon);var e=Math.PI/180,f=b.lat*e,g=b.lon*e,h=c.lat*e,i=c.lon*e,j=2*Math.asin(Math.sqrt(Math.pow(Math.sin((f-h)/2),2)+Math.cos(f)*Math.cos(h)*Math.pow(Math.sin((g-i)/2),2))),k=Math.atan2(Math.sin(g-i)*Math.cos(h),Math.cos(f)*Math.sin(h)-Math.sin(f)*Math.cos(h)*Math.cos(g-i))/-(Math.PI/180);k=k<0?360+k:k;var l=Math.sin((1-d)*j)/Math.sin(j),m=Math.sin(d*j)/Math.sin(j),n=l*Math.cos(f)*Math.cos(g)+m*Math.cos(h)*Math.cos(i),o=l*Math.cos(f)*Math.sin(g)+m*Math.cos(h)*Math.sin(i),p=l*Math.sin(f)+m*Math.sin(h),q=Math.atan2(p,Math.sqrt(Math.pow(n,2)+Math.pow(o,2))),r=Math.atan2(o,n);return new a.Location(q/e,r/e)},a.Transformation=function(a,b,c,d,e,f){this.ax=a,this.bx=b,this.cx=c,this.ay=d,this.by=e,this.cy=f},a.Transformation.prototype={ax:0,bx:0,cx:0,ay:0,by:0,cy:0,transform:function(b){return new a.Point(this.ax*b.x+this.bx*b.y+this.cx,this.ay*b.x+this.by*b.y+this.cy)},untransform:function(b){return new a.Point((b.x*this.by-b.y*this.bx-this.cx*this.by+this.cy*this.bx)/(this.ax*this.by-this.ay*this.bx),(b.x*this.ay-b.y*this.ax-this.cx*this.ay+this.cy*this.ax)/(this.bx*this.ay-this.by*this.ax))}},a.deriveTransformation=function(b,c,d,e,f,g,h,i,j,k,l,m){var n=a.linearSolution(b,c,d,f,g,h,j,k,l),o=a.linearSolution(b,c,e,f,g,i,j,k,m);return new a.Transformation(n[0],n[1],n[2],o[0],o[1],o[2])},a.linearSolution=function(a,b,c,d,e,f,g,h,i){a=parseFloat(a),b=parseFloat(b),c=parseFloat(c),d=parseFloat(d),e=parseFloat(e),f=parseFloat(f),g=parseFloat(g),h=parseFloat(h),i=parseFloat(i);var j=((f-i)*(b-e)-(c-f)*(e-h))/((d-g)*(b-e)-(a-d)*(e-h)),k=((f-i)*(a-d)-(c-f)*(d-g))/((e-h)*(a-d)-(b-e)*(d-g)),l=c-a*j-b*k;return[j,k,l]},a.Projection=function(b,c){c||(c=new a.Transformation(1,0,0,0,1,0)),this.zoom=b,this.transformation=c},a.Projection.prototype={zoom:0,transformation:null,rawProject:function(a){throw"Abstract method not implemented by subclass."},rawUnproject:function(a){throw"Abstract method not implemented by subclass."},project:function(a){a=this.rawProject(a),this.transformation&&(a=this.transformation.transform(a));return a},unproject:function(a){this.transformation&&(a=this.transformation.untransform(a)),a=this.rawUnproject(a);return a},locationCoordinate:function(b){var c=new a.Point(Math.PI*b.lon/180,Math.PI*b.lat/180);c=this.project(c);return new a.Coordinate(c.y,c.x,this.zoom)},coordinateLocation:function(b){b=b.zoomTo(this.zoom);var c=new a.Point(b.column,b.row);c=this.unproject(c);return new a.Location(180*c.y/Math.PI,180*c.x/Math.PI)}},a.LinearProjection=function(b,c){a.Projection.call(this,b,c)},a.LinearProjection.prototype={rawProject:function(b){return new a.Point(b.x,b.y)},rawUnproject:function(b){return new a.Point(b.x,b.y)}},a.extend(a.LinearProjection,a.Projection),a.MercatorProjection=function(b,c){a.Projection.call(this,b,c)},a.MercatorProjection.prototype={rawProject:function(b){return new a.Point(b.x,Math.log(Math.tan(.25*Math.PI+.5*b.y)))},rawUnproject:function(b){return new a.Point(b.x,2*Math.atan(Math.pow(Math.E,b.y))-.5*Math.PI)}},a.extend(a.MercatorProjection,a.Projection),a.MapProvider=function(a){a&&(this.getTileUrl=a)},a.MapProvider.prototype={projection:new a.MercatorProjection(0,a.deriveTransformation(-Math.PI,Math.PI,0,0,Math.PI,Math.PI,1,0,-Math.PI,-Math.PI,0,1)),tileWidth:256,tileHeight:256,topLeftOuterLimit:new a.Coordinate(0,0,0),bottomRightInnerLimit:(new a.Coordinate(1,1,0)).zoomTo(18),getTileUrl:function(a){throw"Abstract method not implemented by subclass."},locationCoordinate:function(a){return this.projection.locationCoordinate(a)},coordinateLocation:function(a){return this.projection.coordinateLocation(a)},outerLimits:function(){return[this.topLeftOuterLimit.copy(),this.bottomRightInnerLimit.copy()]},setZoomRange:function(a,b){this.topLeftOuterLimit=this.topLeftOuterLimit.zoomTo(a),this.bottomRightInnerLimit=this.bottomRightInnerLimit.zoomTo(b)},sourceCoordinate:function(b){var c=this.topLeftOuterLimit.zoomTo(b.zoom),d=this.bottomRightInnerLimit.zoomTo(b.zoom),e=d.row-c.row;if(b.row<0|b.row>=e)return null;var f=d.column-c.column,g=b.column%f;while(g<0)g+=f;return new a.Coordinate(b.row,g,b.zoom)}},a.TemplatedMapProvider=function(b,c){a.MapProvider.call(this,function(a){a=this.sourceCoordinate(a);if(!a)return null;var d=b;if(c&&c.length&&d.indexOf("{S}")>=0){var e=parseInt(a.zoom+a.row+a.column,10)%c.length;d=d.replace("{S}",c[e])}return d.replace("{Z}",a.zoom.toFixed(0)).replace("{X}",a.column.toFixed(0)).replace("{Y}",a.row.toFixed(0))})},a.extend(a.TemplatedMapProvider,a.MapProvider),a.getMousePoint=function(b,c){var d=new a.Point(b.clientX,b.clientY);d.x+=document.body.scrollLeft+document.documentElement.scrollLeft,d.y+=document.body.scrollTop+document.documentElement.scrollTop;for(var e=c.parent;e;e=e.offsetParent)d.x-=e.offsetLeft,d.y-=e.offsetTop;return d},a.MouseWheelHandler=function(a){a!==undefined&&this.init(a)},a.MouseWheelHandler.prototype={init:function(b){this.map=b,this._mouseWheel=a.bind(this.mouseWheel,this),a.addEvent(b.parent,"mousewheel",this._mouseWheel)},remove:function(){a.removeEvent(this.map.parent,"mousewheel",this._mouseWheel)},mouseWheel:function(b){var c=0;this.prevTime=this.prevTime||(new Date).getTime(),b.wheelDelta?c=b.wheelDelta:b.detail&&(c=-b.detail);var d=(new Date).getTime()-this.prevTime;if(Math.abs(c)>0&&d>200){var e=a.getMousePoint(b,this.map);this.map.zoomByAbout(c>0?1:-1,e),this.prevTime=(new Date).getTime()}return a.cancelEvent(b)}},a.DoubleClickHandler=function(a){a!==undefined&&this.init(a)},a.DoubleClickHandler.prototype={init:function(b){this.map=b,this._doubleClick=a.bind(this.doubleClick,this),a.addEvent(b.parent,"dblclick",this._doubleClick)},remove:function(){a.removeEvent(this.map.parent,"dblclick",this._doubleClick)},doubleClick:function(b){var c=a.getMousePoint(b,this.map);this.map.zoomByAbout(b.shiftKey?-1:1,c);return a.cancelEvent(b)}},a.DragHandler=function(a){a!==undefined&&this.init(a)},a.DragHandler.prototype={init:function(b){this.map=b,this._mouseDown=a.bind(this.mouseDown,this),a.addEvent(b.parent,"mousedown",this._mouseDown)},remove:function(){a.removeEvent(this.map.parent,"mousedown",this._mouseDown)},mouseDown:function(b){a.addEvent(document,"mouseup",this._mouseUp=a.bind(this.mouseUp,this)),a.addEvent(document,"mousemove",this._mouseMove=a.bind(this.mouseMove,this)),this.prevMouse=new a.Point(b.clientX,b.clientY),this.map.parent.style.cursor="move";return a.cancelEvent(b)},mouseMove:function(b){this.prevMouse&&(this.map.panBy(b.clientX-this.prevMouse.x,b.clientY-this.prevMouse.y),this.prevMouse.x=b.clientX,this.prevMouse.y=b.clientY,this.prevMouse.t=+(new Date));return a.cancelEvent(b)},mouseUp:function(b){a.removeEvent(document,"mouseup",this._mouseUp),a.removeEvent(document,"mousemove",this._mouseMove),this.prevMouse=null,this.map.parent.style.cursor="";return a.cancelEvent(b)}},a.MouseHandler=function(a){a!==undefined&&this.init(a)},a.MouseHandler.prototype={init:function(b){this.map=b,this.handlers=[new a.DragHandler(b),new a.DoubleClickHandler(b),new a.MouseWheelHandler(b)]},remove:function(){for(var a=0;a<this.handlers.length;a++)this.handlers[a].remove()}},a.TouchHandler=function(){},a.TouchHandler.prototype={maxTapTime:250,maxTapDistance:30,maxDoubleTapDelay:350,locations:{},taps:[],wasPinching:!1,lastPinchCenter:null,init:function(b,c){this.map=b,c=c||{},this._touchStartMachine=a.bind(this.touchStartMachine,this),this._touchMoveMachine=a.bind(this.touchMoveMachine,this),this._touchEndMachine=a.bind(this.touchEndMachine,this),a.addEvent(b.parent,"touchstart",this._touchStartMachine),a.addEvent(b.parent,"touchmove",this._touchMoveMachine),a.addEvent(b.parent,"touchend",this._touchEndMachine),this.options={},this.options.snapToZoom=c.snapToZoom||!0},remove:function(){a.removeEvent(this.map.parent,"touchstart",this._touchStartMachine),a.removeEvent(this.map.parent,"touchmove",this._touchMoveMachine),a.removeEvent(this.map.parent,"touchend",this._touchEndMachine)},updateTouches:function(a){for(var b=0;b<a.touches.length;b+=1){var c=a.touches[b];if(c.identifier in this.locations){var d=this.locations[c.identifier];d.x=c.screenX,d.y=c.screenY,d.scale=a.scale}else this.locations[c.identifier]={scale:a.scale,startPos:{x:c.screenX,y:c.screenY},x:c.screenX,y:c.screenY,time:(new Date).getTime()}}},sameTouch:function(a,b){return a&&a.touch&&b.identifier==a.touch.identifier},touchStartMachine:function(b){this.updateTouches(b);return a.cancelEvent(b)},touchMoveMachine:function(b){switch(b.touches.length){case 1:this.onPanning(b.touches[0]);break;case 2:this.onPinching(b)}this.updateTouches(b);return a.cancelEvent(b)},touchEndMachine:function(b){var c=(new Date).getTime();b.touches.length===0&&this.wasPinching&&this.onPinched(this.lastPinchCenter);for(var d=0;d<b.changedTouches.length;d+=1){var e=b.changedTouches[d],f=this.locations[e.identifier];if(!f||f.wasPinch)continue;var g={x:e.screenX,y:e.screenY},h=c-f.time,i=a.Point.distance(g,f.startPos);i>this.maxTapDistance||(h>this.maxTapTime?(g.end=c,g.duration=h,this.onHold(g)):(g.time=c,this.onTap(g)))}var j={};for(var k=0;k<b.touches.length;k++)j[b.touches[k].identifier]=!0;for(var l in this.locations)l in j||delete j[l];return a.cancelEvent(b)},onHold:function(a){},onTap:function(a){this.taps.length&&a.time-this.taps[0].time<this.maxDoubleTapDelay?(this.onDoubleTap(a),this.taps=[]):this.taps=[a]},onDoubleTap:function(b){var c=this.map.getZoom(),d=Math.round(c)+1,e=d-c,f=new a.Point(b.x,b.y);this.map.zoomByAbout(e,f)},onPanning:function(a){var b={x:a.screenX,y:a.screenY},c=this.locations[a.identifier];this.map.panBy(b.x-c.x,b.y-c.y)},onPinching:function(b){var c=b.touches[0],d=b.touches[1],e=new a.Point(c.screenX,c.screenY),f=new a.Point(d.screenX,d.screenY),g=this.locations[c.identifier],h=this.locations[d.identifier];g.wasPinch=!0,h.wasPinch=!0;var i=a.Point.interpolate(e,f,.5);this.map.zoomByAbout(Math.log(b.scale)/Math.LN2-Math.log(g.scale)/Math.LN2,i);var j=a.Point.interpolate(g,h,.5);this.map.panBy(i.x-j.x,i.y-j.y),this.wasPinching=!0,this.lastPinchCenter=i},onPinched:function(a){if(this.options.snapToZoom){var b=this.map.getZoom(),c=Math.round(b);this.map.zoomByAbout(c-b,a)}this.wasPinching=!1}},a.CallbackManager=function(a,b){this.owner=a,this.callbacks={};for(var c=0;c<b.length;c++)this.callbacks[b[c]]=[]},a.CallbackManager.prototype={owner:null,callbacks:null,addCallback:function(a,b){typeof b=="function"&&this.callbacks[a]&&this.callbacks[a].push(b)},removeCallback:function(a,b){if(typeof b=="function"&&this.callbacks[a]){var c=this.callbacks[a],d=c.length;for(var e=0;e<d;e++)if(c[e]===b){c.splice(e,1);break}}},dispatchCallback:function(a,b){if(this.callbacks[a])for(var c=0;c<this.callbacks[a].length;c+=1)try{this.callbacks[a][c](this.owner,b)}catch(d){}}},a.RequestManager=function(){this.loadingBay=document.createDocumentFragment(),this.requestsById={},this.openRequestCount=0,this.maxOpenRequests=4,this.requestQueue=[],this.callbackManager=new a.CallbackManager(this,["requestcomplete"])},a.RequestManager.prototype={loadingBay:null,requestsById:null,requestQueue:null,openRequestCount:null,maxOpenRequests:null,callbackManager:null,addCallback:function(a,b){this.callbackManager.addCallback(a,b)},removeCallback:function(a,b){this.callbackManager.removeCallback(a,b)},dispatchCallback:function(a,b){this.callbackManager.dispatchCallback(a,b)},clear:function(){this.clearExcept({})},clearExcept:function(a){for(var b=0;b<this.requestQueue.length;b++){var c=this.requestQueue[b];c&&!(c.id in a)&&(this.requestQueue[b]=null)}var d=this.loadingBay.childNodes;for(var e=d.length-1;e>=0;e--){var f=d[e];f.id in a||(this.loadingBay.removeChild(f),this.openRequestCount--,f.src=f.coord=f.onload=f.onerror=null)}for(var g in this.requestsById)if(this.requestsById.hasOwnProperty(g)&&!(g in a)){var h=this.requestsById[g];delete this.requestsById[g],h!==null&&(h=h.id=h.coord=h.url=null)}},hasRequest:function(a){return a in this.requestsById},requestTile:function(a,b,c){if(!(a in this.requestsById)){var d={id:a,coord:b.copy(),url:c};this.requestsById[a]=d,c&&this.requestQueue.push(d)}},getProcessQueue:function(){if(!this._processQueue){var a=this;this._processQueue=function(){a.processQueue()}}return this._processQueue},processQueue:function(a){a&&this.requestQueue.length>8&&this.requestQueue.sort(a);while(this.openRequestCount<this.maxOpenRequests&&this.requestQueue.length>0){var b=this.requestQueue.pop();if(b){this.openRequestCount++;var c=document.createElement("img");c.id=b.id,c.style.position="absolute",c.coord=b.coord,this.loadingBay.appendChild(c),c.onload=c.onerror=this.getLoadComplete(),c.src=b.url,b=b.id=b.coord=b.url=null}}},_loadComplete:null,getLoadComplete:function(){if(!this._loadComplete){var a=this;this._loadComplete=function(b){b=b||window.event;var c=b.srcElement||b.target;c.onload=c.onerror=null,a.loadingBay.removeChild(c),a.openRequestCount--,delete a.requestsById[c.id],b.type==="load"&&(c.complete||c.readyState&&c.readyState=="complete")?a.dispatchCallback("requestcomplete",c):c.src=null,setTimeout(a.getProcessQueue(),0)}}return this._loadComplete}},a.Map=function(b,c,d,e){if(typeof b=="string"){b=document.getElementById(b);if(!b)throw"The ID provided to modest maps could not be found."}this.parent=b,this.parent.style.padding="0",this.parent.style.overflow="hidden";var f=a.getStyle(this.parent,"position");f!="relative"&&f!="absolute"&&(this.parent.style.position="relative");if(!d){d=new a.Point(this.parent.offsetWidth,this.parent.offsetHeight),this.autoSize=!0;var g=this;a.addEvent(window,"resize",this.windowResize())}else this.autoSize=!1,this.parent.style.width=Math.round(d.x)+"px",this.parent.style.height=Math.round(d.y)+"px";this.dimensions=d,this.requestManager=new a.RequestManager(this.parent),this.requestManager.addCallback("requestcomplete",this.getTileComplete()),this.layers={},this.layerParent=document.createElement("div"),this.layerParent.id=this.parent.id+"-layers",this.layerParent.style.cssText="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; z-index: 0",this.parent.appendChild(this.layerParent),this.coordinate=new a.Coordinate(.5,.5,0),this.setProvider(c),this.enablePyramidLoading=!1,this.callbackManager=new a.CallbackManager(this,["zoomed","panned","centered","extentset","resized","drawn"]);if(e===undefined)this.eventHandlers=[],this.eventHandlers.push(new a.MouseHandler(this));else{this.eventHandlers=e;if(e instanceof Array)for(var h=0;h<e.length;h++)e[h].init(this)}},a.Map.prototype={parent:null,provider:null,dimensions:null,coordinate:null,tiles:null,layers:null,layerParent:null,requestManager:null,tileCacheSize:null,maxTileCacheSize:null,recentTiles:null,recentTilesById:null,recentTileSize:null,callbackManager:null,eventHandlers:null,autoSize:null,toString:function(){return"Map(#"+this.parent.id+")"},addCallback:function(a,b){this.callbackManager.addCallback(a,b)},removeCallback:function(a,b){this.callbackManager.removeCallback(a,b)},dispatchCallback:function(a,b){this.callbackManager.dispatchCallback(a,b)},windowResize:function(){if(!this._windowResize){var b=this;this._windowResize=function(c){b.dimensions=new a.Point(b.parent.offsetWidth,b.parent.offsetHeight),b.draw(),b.dispatchCallback("resized",[b.dimensions])}}return this._windowResize},zoomBy:function(b){this.coordinate=this.enforceLimits(this.coordinate.zoomBy(b)),a.getFrame(this.getRedraw()),this.dispatchCallback("zoomed",b);return this},zoomIn:function(){return this.zoomBy(1)},zoomOut:function(){return this.zoomBy(-1)},setZoom:function(a){return this.zoomBy(a-this.coordinate.zoom)},zoomByAbout:function(a,b){var c=this.pointLocation(b);this.coordinate=this.enforceLimits(this.coordinate.zoomBy(a));var d=this.locationPoint(c);this.dispatchCallback("zoomed",a);return this.panBy(b.x-d.x,b.y-d.y)},panBy:function(b,c){this.coordinate.column-=b/this.provider.tileWidth,this.coordinate.row-=c/this.provider.tileHeight,this.coordinate=this.enforceLimits(this.coordinate),a.getFrame(this.getRedraw()),this.dispatchCallback("panned",[b,c]);return this},panLeft:function(){return this.panBy(100,0)},panRight:function(){return this.panBy(-100,0)},panDown:function(){return this.panBy(0,-100)},panUp:function(){return this.panBy(0,100)},setCenter:function(a){return this.setCenterZoom(a,this.coordinate.zoom)},setCenterZoom:function(a,b){this.coordinate=this.provider.locationCoordinate(a).zoomTo(parseFloat(b)||0),this.draw(),this.dispatchCallback("centered",[a,b]);return this},setExtent:function(b,c){var d,e;for(var f=0;f<b.length;f++){var g=this.provider.locationCoordinate(b[f]);d?(d.row=Math.min(d.row,g.row),d.column=Math.min(d.column,g.column),d.zoom=Math.min(d.zoom,g.zoom),e.row=Math.max(e.row,g.row),e.column=Math.max(e.column,g.column),e.zoom=Math.max(e.zoom,g.zoom)):(d=g.copy(),e=g.copy())}var h=this.dimensions.x+1,i=this.dimensions.y+1,j=(e.column-d.column)/(h/this.provider.tileWidth),k=Math.log(j)/Math.log(2),l=d.zoom-(c?k:Math.ceil(k)),m=(e.row-d.row)/(i/this.provider.tileHeight),n=Math.log(m)/Math.log(2),o=d.zoom-(c?n:Math.ceil(n)),p=Math.min(l,o);p=Math.min(p,this.provider.outerLimits()[1].zoom),p=Math.max(p,this.provider.outerLimits()[0].zoom);var q=(d.row+e.row)/2,r=(d.column+e.column)/2,s=d.zoom;this.coordinate=(new a.Coordinate(q,r,s)).zoomTo(p),this.draw(),this.dispatchCallback("extentset",b);return this},setSize:function(b,c){b.hasOwnProperty("x")&&b.hasOwnProperty("y")?this.dimensions=b:c!==undefined&&!isNaN(c)&&(this.dimensions=new a.Point(b,c)),this.parent.style.width=Math.round(this.dimensions.x)+"px",this.parent.style.height=Math.round(this.dimensions.y)+"px",this.draw(),this.dispatchCallback("resized",[this.dimensions]);return this},coordinatePoint:function(b){b.zoom!=this.coordinate.zoom&&(b=b.zoomTo(this.coordinate.zoom));var c=new a.Point(this.dimensions.x/2,this.dimensions.y/2);c.x+=this.provider.tileWidth*(b.column-this.coordinate.column),c.y+=this.provider.tileHeight*(b.row-this.coordinate.row);return c},pointCoordinate:function(a){var b=this.coordinate.copy();b.column+=(a.x-this.dimensions.x/2)/this.provider.tileWidth,b.row+=(a.y-this.dimensions.y/2)/this.provider.tileHeight;return b},locationPoint:function(a){return this.coordinatePoint(this.provider.locationCoordinate(a))},pointLocation:function(a){return this.provider.coordinateLocation(this.pointCoordinate(a))},getExtent:function(){var b=[];b.push(this.pointLocation(new a.Point(0,0))),b.push(this.pointLocation(this.dimensions));return b},getCenter:function(){return this.provider.coordinateLocation(this.coordinate)},getZoom:function(){return this.coordinate.zoom},setProvider:function(a){var b=!1;this.provider===null&&(b=!0);if(!b){this.requestManager.clear();for(var c in this.layers)if(this.layers.hasOwnProperty(c)){var d=this.layers[c];while(d.firstChild)d.removeChild(d.firstChild)}}this.tiles={},this.tileCacheSize=0,this.maxTileCacheSize=64,this.recentTiles=[],this.recentTilesById={},this.provider=a,b||this.draw();return this},enforceLimits:function(a){a=a.copy();var b=this.provider.outerLimits();if(b){var c=b[0].zoom,d=b[1].zoom;a.zoom<c?a=a.zoomTo(c):a.zoom>d&&(a=a.zoomTo(d))}return a},draw:function(){this.coordinate=this.enforceLimits(this.coordinate);var b=Math.round(this.coordinate.zoom);if(this.dimensions.x<=0||this.dimensions.y<=0){if(!this.autoSize)return;var c=this.parent.offsetWidth,d=this.parent.offsetHeight;this.dimensions=new a.Point(c,d);if(c<=0||d<=0)return}var e=this.pointCoordinate(new a.Point(0,0)).zoomTo(b).container(),f=this.pointCoordinate(this.dimensions).zoomTo(b).container().right().down(),g=0;g&&(e=e.left(g).up(g),f=f.right(g).down(g));var h={},i=this.createOrGetLayer(e.zoom),j=e.copy();for(j.column=e.column;j.column<=f.column;j.column+=1)for(j.row=e.row;j.row<=f.row;j.row+=1){var k=j.toKey();h[k]=!0;if(k in this.tiles){var l=this.tiles[k];l.parentNode!=i&&i.appendChild(l)}else{if(!this.requestManager.hasRequest(k)){var m=this.provider.getTileUrl(j);this.requestManager.requestTile(k,j,m)}var n=!1,o=j.zoom;for(var p=1;p<=o;p++){var q=j.zoomBy(-p).container(),r=q.toKey();if(this.enablePyramidLoading){h[r]=!0;var s=this.createOrGetLayer(q.zoom);if(r in this.tiles){var t=this.tiles[r];t.parentNode!=s&&s.appendChild(t)}else this.requestManager.hasRequest(r)||this.requestManager.requestTile(r,q,this.provider.getTileUrl(q))}else if(r in this.tiles){h[r]=!0,n=!0;break}}if(!n&&!this.enablePyramidLoading){var u=j.zoomBy(1);h[u.toKey()]=!0,u.column+=1,h[u.toKey()]=!0,u.row+=1,h[u.toKey()]=!0,u.column-=1,h[u.toKey()]=!0}}}for(var v in this.layers)if(this.layers.hasOwnProperty(v)){var w=parseInt(v,10);if(w>=e.zoom-5&&w<e.zoom+2)continue;var x=this.layers[v];x.style.display="none";var y=x.getElementsByTagName("img");for(var z=y.length-1;z>=0;z--)x.removeChild(y[z])}var A=(new Date).getTime(),B=e.zoom-5,C=e.zoom+2;for(var D=B;D<C;D++){var x=this.layers[D];if(!x)continue;var E=1,F=this.coordinate.copy(),y=x.getElementsByTagName("img");y.length>0?(x.style.display="block",E=Math.pow(2,this.coordinate.zoom-D),F=F.zoomTo(D)):x.style.display="none";var G=this.provider.tileWidth*E,H=this.provider.tileHeight*E,I=new a.Point(this.dimensions.x/2,this.dimensions.y/2);for(var z=y.length-1;z>=0;z--){var l=y[z];h[l.id]?(a.moveElement(l,{x:Math.round(I.x+(l.coord.column-F.column)*G),y:Math.round(I.y+(l.coord.row-F.row)*H),scale:E,width:this.provider.tileWidth,height:this.provider.tileHeight}),this.recentTilesById[l.id].lastTouchedTime=A):x.removeChild(l)}}this.requestManager.clearExcept(h),this.requestManager.processQueue(this.getCenterDistanceCompare()),this.checkCache(),this.dispatchCallback("drawn")},_tileComplete:null,getTileComplete:function(){if(!this._tileComplete){var b=this;this._tileComplete=function(c,d){b.tiles[d.id]=d,b.tileCacheSize++;var e={id:d.id,lastTouchedTime:(new Date).getTime()};b.recentTilesById[d.id]=e,b.recentTiles.push(e);var f=b.coordinate.zoomTo(d.coord.zoom),g=Math.pow(2,b.coordinate.zoom-d.coord.zoom),h=b.dimensions.x/2+(d.coord.column-f.column)*b.provider.tileWidth*g,i=b.dimensions.y/2+(d.coord.row-f.row)*b.provider.tileHeight*g;a.moveElement(d,{x:Math.round(h),y:Math.round(i),scale:g,width:b.provider.tileWidth,height:b.provider.tileHeight});var j=b.layers[d.coord.zoom];j.appendChild(d),d.className="map-tile-loaded",Math.round(b.coordinate.zoom)===d.coord.zoom&&(j.style.display="block"),b.requestRedraw()}}return this._tileComplete},_redrawTimer:undefined,requestRedraw:function(){this._redrawTimer||(this._redrawTimer=setTimeout(this.getRedraw(),1e3))},_redraw:null,getRedraw:function(){if(!this._redraw){var a=this;this._redraw=function(){a.draw(),a._redrawTimer=0}}return this._redraw},createOrGetLayer:function(a){if(a in this.layers)return this.layers[a];var b=document.createElement("div");b.id=this.parent.id+"-zoom-"+a,b.style.cssText=this.layerParent.style.cssText,b.style.zIndex=a,this.layerParent.appendChild(b),this.layers[a]=b;return b},checkCache:function(){var a=this.parent.getElementsByTagName("img").length,b=Math.max(a,this.maxTileCacheSize);this.tileCacheSize>b&&this.recentTiles.sort(function(a,b){return b.lastTouchedTime<a.lastTouchedTime?-1:b.lastTouchedTime>a.lastTouchedTime?1:0});while(this.tileCacheSize>b){var c=this.recentTiles.pop(),d=(new Date).getTime();delete this.recentTilesById[c.id];var e=this.tiles[c.id];e.parentNode?alert("Gah: trying to removing cached tile even though it's still in the DOM"):(delete this.tiles[c.id],this.tileCacheSize--)}},getCenterDistanceCompare:function(){var a=this.coordinate.zoomTo(Math.round(this.coordinate.zoom));return function(b,c){if(b&&c){var d=b.coord,e=c.coord;if(d.zoom==e.zoom){var f=Math.abs(a.row-d.row-.5)+Math.abs(a.column-d.column-.5),g=Math.abs(a.row-e.row-.5)+Math.abs(a.column-e.column-.5);return f<g?1:f>g?-1:0}return d.zoom<e.zoom?1:d.zoom>e.zoom?-1:0}return b?1:c?-1:0}},destroy:function(){this.requestManager.clear();for(var b=0;b<this.eventHandlers.length;b++)this.eventHandlers[b].remove();this.parent.removeChild(this.layerParent),a.removeEvent(window,"resize",this.windowResize());return this}},typeof module!="undefined"&&module.exports&&(module.exports={Point:a.Point,Projection:a.Projection,MercatorProjection:a.MercatorProjection,LinearProjection:a.LinearProjection,Transformation:a.Transformation,Location:a.Location,MapProvider:a.MapProvider,TemplatedMapProvider:a.TemplatedMapProvider,Coordinate:a.Coordinate})})(com.modestmaps)